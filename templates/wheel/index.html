{% extends "base.html" %}

{% block title %}Ruleta del Destino - TravelBoard{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="text-center mb-4">
            <h1 class="display-5 mb-3" id="wheel-title">¿A quién le toca?</h1>
            
            <!-- Resultado de la ruleta -->
            <div id="result-container" style="display: none;" class="mb-4 mt-3">
                <div class="alert alert-success">
                    <h3 class="mb-0">
                        <i class="fas fa-trophy me-2"></i>Resultado:
                        <span id="result-name" class="fw-bold text-danger"></span>
                    </h3>
                </div>
            </div>
        </div>
        
        <div class="wheel-container text-center position-relative">
            <!-- Canvas para la ruleta -->
            <div id="wheel-canvas" style="position: relative; margin: 0 auto; width: 300px; height: 300px;"></div>
            
            <!-- Botón para girar -->
            <button id="spin-button" class="btn btn-primary btn-lg mt-3">
                ¡MENEA!
            </button>
        </div>
        
        <div class="text-center mt-4">
            <a href="{{ url_for('index') }}" class="btn btn-secondary">
                <i class="fas fa-arrow-left me-2"></i>Volver al inicio
            </a>
        </div>
    </div>
</div>
{% endblock %}

{% block sidebar %}
<div class="card">
    <div class="card-header bg-primary text-white">
        <h5 class="mb-0"><i class="fas fa-info-circle me-2"></i>Información</h5>
    </div>
    <div class="card-body">
        <p>La ruleta te permite elegir a un compañero de viaje al azar para cualquier tipo de actividad o decisión.</p>
        
        <h6 class="mt-3">¿Cómo funciona?</h6>
        <ul>
            <li>Haz clic en el botón para girar la ruleta</li>
            <li>Espera a que la ruleta se detenga completamente</li>
            <li>¡La persona seleccionada aparecerá en la parte superior!</li>
        </ul>
        
        <div class="alert alert-info mt-3">
            <i class="fas fa-lightbulb me-2"></i>
            <strong>Consejo:</strong> Usa la ruleta para decisiones como quién paga la próxima ronda, quién conduce, o quién elige el restaurante.
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Variables y elementos del DOM
        const spinButton = document.getElementById('spin-button');
        const resultContainer = document.getElementById('result-container');
        const resultName = document.getElementById('result-name');
        const wheelTitle = document.getElementById('wheel-title');
        const wheelCanvas = document.getElementById('wheel-canvas');
        
        // Array para almacenar los nombres reales
        let fullNames = [];
        
        // Cargar título personalizado
        fetch('/api/wheel/title')
            .then(response => response.json())
            .then(data => {
                if (data.success && data.title) {
                    wheelTitle.textContent = data.title;
                }
            })
            .catch(error => {
                console.error('Error cargando título:', error);
            });
        
        // Cargar usuarios
        fetch('/api/wheel/users')
            .then(response => response.json())
            .then(data => {
                if (data.success && data.users.length > 0) {
                    initWheel(data.users);
                } else {
                    // Usuarios de prueba
                    const fallbackUsers = [
                        { id: 1, name: 'Maricristi_Batukada' },
                        { id: 2, name: 'Marta_Boxing' },
                        { id: 3, name: 'Marisa_Venenosa' },
                        { id: 4, name: 'Ferson_Avionetas' },
                        { id: 5, name: 'Luis_Keta' },
                        { id: 6, name: 'Alfon_Marques' },
                        { id: 7, name: 'Omar_Jeque' },
                        { id: 8, name: 'Javi_Buceador' },
                        { id: 9, name: 'Diego_Roman' },
                        { id: 10, name: 'Angel_Garrapata' },
                        { id: 11, name: 'Isidro_Patachula' },
                        { id: 12, name: 'Nacho33' },
                        { id: 13, name: 'Carlos_Pupas' }
                    ];
                    initWheel(fallbackUsers);
                }
            })
            .catch(error => {
                console.error('Error cargando usuarios:', error);
                // Usuarios de respaldo en caso de error
                const fallbackUsers = [
                    { id: 1, name: 'Maricristi_Batukada' },
                    { id: 2, name: 'Marta_Boxing' },
                    { id: 3, name: 'Marisa_Venenosa' },
                    { id: 4, name: 'Ferson_Avionetas' },
                    { id: 5, name: 'Luis_Keta' },
                    { id: 6, name: 'Alfon_Marques' },
                    { id: 7, name: 'Omar_Jeque' },
                    { id: 8, name: 'Javi_Buceador' },
                    { id: 9, name: 'Diego_Roman' },
                    { id: 10, name: 'Angel_Garrapata' },
                    { id: 11, name: 'Isidro_Patachula' },
                    { id: 12, name: 'Nacho33' },
                    { id: 13, name: 'Carlos_Pupas' }
                ];
                initWheel(fallbackUsers);
            });
        
        // Función para obtener solo el primer nombre (antes del guion bajo)
        function getFirstName(fullName) {
            if (fullName.includes('_')) {
                return fullName.split('_')[0];
            }
            return fullName;
        }
        
        // Crear la ruleta de manera simple
        function initWheel(users) {
            // Limpiar el canvas
            wheelCanvas.innerHTML = '';
            
            // Crear un array de nombres cortos
            const shortNames = users.map(user => getFirstName(user.name));
            
            // Guardar los nombres completos
            fullNames = users.map(user => user.name);
            
            // Crear colores para los segmentos
            const colors = [
                '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', 
                '#9966FF', '#FF9F40', '#8AC249', '#EA5F89',
                '#00BFFF', '#FFA07A', '#20B2AA', '#FF6347',
                '#9370DB', '#32CD32', '#FFD700', '#87CEFA'
            ];
            
            // Crear la ruleta mediante un div circular dividido en segmentos
            const numSegments = users.length;
            const segmentAngle = 360 / numSegments;
            
            // Crear el contenedor de la ruleta
            const wheel = document.createElement('div');
            wheel.className = 'wheel';
            wheel.style.width = '100%';
            wheel.style.height = '100%';
            wheel.style.borderRadius = '50%';
            wheel.style.position = 'relative';
            wheel.style.overflow = 'hidden';
            wheel.style.transition = 'transform 5s cubic-bezier(0.2, 0.8, 0.2, 1)';
            
            // Crear los segmentos
            for (let i = 0; i < numSegments; i++) {
                const segment = document.createElement('div');
                segment.className = 'segment';
                segment.style.position = 'absolute';
                segment.style.width = '50%';
                segment.style.height = '50%';
                segment.style.left = '50%';
                segment.style.top = '0';
                segment.style.transformOrigin = 'bottom left';
                segment.style.transform = `rotate(${i * segmentAngle}deg)`;
                
                // Crear el contenido del segmento (triángulo coloreado)
                const content = document.createElement('div');
                content.style.position = 'absolute';
                content.style.width = '100%';
                content.style.height = '100%';
                content.style.transformOrigin = 'bottom left';
                content.style.clipPath = 'polygon(0 0, 100% 0, 0 100%)';
                content.style.backgroundColor = colors[i % colors.length];
                
                // Añadir el texto
                const text = document.createElement('div');
                text.textContent = shortNames[i];
                text.style.position = 'absolute';
                text.style.left = '30%';
                text.style.top = '25%';
                text.style.transform = 'rotate(-45deg)';
                text.style.color = 'white';
                text.style.fontWeight = 'bold';
                text.style.fontSize = '12px';
                text.style.textShadow = '1px 1px 2px rgba(0,0,0,0.7)';
                
                content.appendChild(text);
                segment.appendChild(content);
                wheel.appendChild(segment);
            }
            
            // Añadir el marcador
            const marker = document.createElement('div');
            marker.className = 'marker';
            marker.style.position = 'absolute';
            marker.style.top = '0';
            marker.style.left = '50%';
            marker.style.transform = 'translateX(-50%)';
            marker.style.width = '20px';
            marker.style.height = '20px';
            marker.style.zIndex = '100';
            
            const markerIcon = document.createElement('i');
            markerIcon.className = 'fas fa-caret-down';
            markerIcon.style.color = 'red';
            markerIcon.style.fontSize = '30px';
            
            marker.appendChild(markerIcon);
            
            // Añadir la ruleta y el marcador al canvas
            wheelCanvas.appendChild(wheel);
            wheelCanvas.appendChild(marker);
            
            // Evento para el botón de girar
            spinButton.addEventListener('click', function() {
                spinWheel(wheel);
            });
        }
        
        // Función para girar la ruleta
        function spinWheel(wheel) {
            // Deshabilitar el botón
            spinButton.disabled = true;
            spinButton.textContent = 'Girando...';
            
            // Ocultar el resultado
            resultContainer.style.display = 'none';
            
            // Generar un ángulo aleatorio para la rotación
            const randomSpins = 5 + Math.random() * 5; // Entre 5 y 10 vueltas
            const randomAngle = Math.floor(Math.random() * 360);
            const totalRotation = randomSpins * 360 + randomAngle;
            
            // Aplicar la rotación
            wheel.style.transform = `rotate(${totalRotation}deg)`;
            
            // Después de que termine la animación, mostrar el resultado
            setTimeout(function() {
                // Determinar el segmento ganador
                const numSegments = fullNames.length;
                const segmentAngle = 360 / numSegments;
                
                // El segmento ganador es el que está en la posición 0 después de la rotación
                // Tenemos que hacer un poco de matemáticas para determinar cuál es
                const normalizedAngle = totalRotation % 360;
                const winningIndex = Math.floor(normalizedAngle / segmentAngle);
                const adjustedIndex = (numSegments - winningIndex) % numSegments;
                
                // Mostrar el ganador
                const winner = fullNames[adjustedIndex];
                resultName.textContent = winner;
                resultContainer.style.display = 'block';
                
                // Habilitar el botón
                spinButton.disabled = false;
                spinButton.textContent = '¡MENEA!';
            }, 5000); // 5 segundos (tiempo de la animación)
        }
    });
</script>
{% endblock %}

{% block extra_css %}
<style>
    .wheel-container {
        margin: 40px auto;
        max-width: 320px;
    }
    
    /* Animación del resultado */
    @keyframes bounce {
        0%, 20%, 50%, 80%, 100% {transform: translateY(0);}
        40% {transform: translateY(-20px);}
        60% {transform: translateY(-10px);}
    }
    
    .bounce {
        animation: bounce 1s;
    }
</style>
{% endblock %}