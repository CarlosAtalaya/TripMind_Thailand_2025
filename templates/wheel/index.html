{% extends "base.html" %}

{% block title %}Ruleta del Destino - TravelBoard{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="text-center mb-4">
            <h1 class="display-5 mb-3" id="wheel-title">¿A quién le toca?</h1>
            
            <!-- Resultado de la ruleta -->
            <div id="result-container" style="display: none;" class="mb-4 mt-3">
                <div class="alert alert-success">
                    <h3 class="mb-0">
                        <i class="fas fa-trophy me-2"></i>Resultado:
                        <span id="result-name" class="fw-bold text-danger"></span>
                    </h3>
                </div>
            </div>
        </div>
        
        <div class="wheel-container text-center">
            <!-- Marcador triangular -->
            <div class="wheel-marker">
                <i class="fas fa-caret-down fa-3x text-danger"></i>
            </div>
            
            <!-- Contenedor de la ruleta -->
            <div id="canvasContainer">
                <canvas id="canvas" width="434" height="434">
                    Canvas no soportado, actualiza tu navegador.
                </canvas>
            </div>
            
            <!-- Botón para girar -->
            <button id="spin-button" class="btn btn-primary btn-lg spin-button">
                ¡MENEA!
            </button>
        </div>
        
        <div class="text-center mt-4">
            <a href="{{ url_for('index') }}" class="btn btn-secondary">
                <i class="fas fa-arrow-left me-2"></i>Volver al inicio
            </a>
        </div>
    </div>
</div>
{% endblock %}

{% block sidebar %}
<div class="card">
    <div class="card-header bg-primary text-white">
        <h5 class="mb-0"><i class="fas fa-info-circle me-2"></i>Información</h5>
    </div>
    <div class="card-body">
        <p>La ruleta te permite elegir a un compañero de viaje al azar para cualquier tipo de actividad o decisión.</p>
        
        <h6 class="mt-3">¿Cómo funciona?</h6>
        <ul>
            <li>Haz clic en el botón para girar la ruleta</li>
            <li>Espera a que la ruleta se detenga completamente</li>
            <li>¡La persona seleccionada aparecerá en la parte superior!</li>
        </ul>
        
        <div class="alert alert-info mt-3">
            <i class="fas fa-lightbulb me-2"></i>
            <strong>Consejo:</strong> Usa la ruleta para decisiones como quién paga la próxima ronda, quién conduce, o quién elige el restaurante.
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
    /* Contenedor de la ruleta */
    .wheel-container {
        position: relative;
        margin: 60px auto 30px;
        max-width: 434px;
    }
    
    /* Marcador triangular */
    .wheel-marker {
        position: absolute;
        top: -40px;
        left: 50%;
        transform: translateX(-50%);
        z-index: 10;
        filter: drop-shadow(0 0 5px rgba(0,0,0,0.3));
    }
    
    /* Contenedor del canvas */
    #canvasContainer {
        position: relative;
        width: 434px;
        height: 434px;
        margin: 0 auto;
    }
    
    /* Botón para girar */
    .spin-button {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 80px;
        height: 80px;
        border-radius: 50%;
        background: linear-gradient(145deg, #0d6efd, #0b5ed7);
        color: white;
        font-weight: bold;
        border: none;
        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 100;
        cursor: pointer;
        transition: all 0.3s ease;
        font-size: 1rem;
    }
    
    .spin-button:hover {
        transform: translate(-50%, -50%) scale(1.05);
        box-shadow: 0 6px 12px rgba(13, 110, 253, 0.4);
    }
    
    .spin-button:active {
        transform: translate(-50%, -50%) scale(0.95);
    }
    
    .spin-button:disabled {
        background: linear-gradient(145deg, #6c757d, #5a6268);
        cursor: not-allowed;
    }
    
    /* Animación del resultado */
    @keyframes bounce {
        0%, 20%, 50%, 80%, 100% {transform: translateY(0);}
        40% {transform: translateY(-20px);}
        60% {transform: translateY(-10px);}
    }
    
    .bounce {
        animation: bounce 1s;
    }
    
    /* Responsive */
    @media (max-width: 576px) {
        #canvasContainer {
            width: 320px;
            height: 320px;
        }
        
        #canvas {
            width: 320px;
            height: 320px;
        }
        
        .spin-button {
            width: 60px;
            height: 60px;
            font-size: 0.8rem;
        }
        
        .wheel-container {
            max-width: 320px;
        }
    }
</style>
{% endblock %}

{% block extra_js %}
<!-- Scripts adicionales -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.9.1/gsap.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/winwheel@1.0.1/dist/Winwheel.min.js"></script>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Variables y elementos del DOM
        let theWheel;
        const spinButton = document.getElementById('spin-button');
        const resultContainer = document.getElementById('result-container');
        const resultName = document.getElementById('result-name');
        const wheelTitle = document.getElementById('wheel-title');
        let isSpinning = false;
        let userSegments = []; // Array para mantener la correspondencia entre segmentos y usuarios
        
        // Colores vibrantes para los segmentos
        const colors = [
            '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', 
            '#9966FF', '#FF9F40', '#8AC249', '#EA5F89',
            '#00BFFF', '#FFA07A', '#20B2AA', '#FF6347',
            '#9370DB', '#32CD32', '#FFD700', '#87CEFA'
        ];
        
        // Cargar título personalizado
        fetch('/api/wheel/title')
            .then(response => response.json())
            .then(data => {
                if (data.success && data.title) {
                    wheelTitle.textContent = data.title;
                }
            })
            .catch(error => {
                console.error('Error cargando título:', error);
            });
        
        // Cargar usuarios
        fetch('/api/wheel/users')
            .then(response => response.json())
            .then(data => {
                if (data.success && data.users.length > 0) {
                    initWheel(data.users);
                } else {
                    // Usuarios de prueba
                    const fallbackUsers = [
                        { id: 1, name: 'Maricristi_Batukada' },
                        { id: 2, name: 'Marta_Boxing' },
                        { id: 3, name: 'Marisa_Venenosa' },
                        { id: 4, name: 'Ferson_Avionetas' },
                        { id: 5, name: 'Luis_Keta' },
                        { id: 6, name: 'Alfon_Marques' },
                        { id: 7, name: 'Omar_Jeque' },
                        { id: 8, name: 'Javi_Buceador' },
                        { id: 9, name: 'Diego_Roman' },
                        { id: 10, name: 'Angel_Garrapata' },
                        { id: 11, name: 'Isidro_Patachula' },
                        { id: 12, name: 'Nacho33' },
                        { id: 13, name: 'Carlos_Pupas' }
                    ];
                    initWheel(fallbackUsers);
                }
            })
            .catch(error => {
                console.error('Error cargando usuarios:', error);
                // Usuarios de respaldo en caso de error
                const fallbackUsers = [
                    { id: 1, name: 'Maricristi_Batukada' },
                    { id: 2, name: 'Marta_Boxing' },
                    { id: 3, name: 'Marisa_Venenosa' },
                    { id: 4, name: 'Ferson_Avionetas' },
                    { id: 5, name: 'Luis_Keta' },
                    { id: 6, name: 'Alfon_Marques' },
                    { id: 7, name: 'Omar_Jeque' },
                    { id: 8, name: 'Javi_Buceador' },
                    { id: 9, name: 'Diego_Roman' },
                    { id: 10, name: 'Angel_Garrapata' },
                    { id: 11, name: 'Isidro_Patachula' },
                    { id: 12, name: 'Nacho33' },
                    { id: 13, name: 'Carlos_Pupas' }
                ];
                initWheel(fallbackUsers);
            });
            
        // Función para obtener solo el primer nombre (antes del guion bajo)
        function getFirstName(fullName) {
            if (fullName.includes('_')) {
                return fullName.split('_')[0];
            }
            return fullName;
        }
        
        // Crear los segmentos para la ruleta
        function createSegments(users) {
            const segments = [];
            userSegments = []; // Reiniciar el array de correspondencia
            
            users.forEach((user, index) => {
                // Extraer solo el primer nombre
                const firstName = getFirstName(user.name);
                
                // Guardar la correspondencia entre índice de segmento y nombre completo
                userSegments.push(user.name);
                
                segments.push({
                    'fillStyle': colors[index % colors.length],
                    'text': firstName,
                    'textFontFamily': 'Arial',
                    'textFontSize': getFontSize(users.length),
                    'textFillStyle': 'white',
                    'textOrientation': 'vertical', // Orientación vertical para los nombres
                    'textMargin': 15,              // Margen para el texto
                    'textAlignment': 'inner'       // Alineación interna para mejor visibilidad
                });
            });
            
            return segments;
        }
        
        // Función para ajustar el tamaño de fuente según el número de usuarios
        function getFontSize(numUsers) {
            if (numUsers <= 6) return 18;
            if (numUsers <= 10) return 16;
            if (numUsers <= 15) return 14;
            if (numUsers <= 20) return 12;
            return 10;
        }
        
        // Inicializar la ruleta con los usuarios
        function initWheel(users) {
            const segments = createSegments(users);
            const canvas = document.getElementById('canvas');
            const centerX = canvas.width / 2;
            const centerY = canvas.height / 2;
            
            // Crear la ruleta
            theWheel = new Winwheel({
                'canvasId': 'canvas',
                'numSegments': segments.length,
                'segments': segments,
                'outerRadius': centerX - 10,
                'centerX': centerX,
                'centerY': centerY,
                'lineWidth': 3,
                'textFontWeight': 'bold',
                'pointerAngle': 0,  // El puntero está en la parte superior
                'animation': {
                    'type': 'spinToStop',
                    'duration': 5,
                    'spins': 8,
                    'callbackFinished': finishSpin
                }
            });
            
            // Dibujar la ruleta
            theWheel.draw();
            console.log("Ruleta inicializada con " + users.length + " segmentos");
        }
        
        // Función para manejar el final del giro
        function finishSpin(indicatedSegment) {
            console.log("Giro finalizado - Segmento indicado:", indicatedSegment);
            
            // Determinar el ganador basado en el segmento indicado
            let winningSegmentNumber = 0;
            
            // Si hay un segmento indicado válido, usamos su número
            if (indicatedSegment && typeof indicatedSegment.text !== 'undefined') {
                // Buscar el índice del segmento en la ruleta
                for (let i = 1; i < theWheel.segments.length; i++) {
                    if (theWheel.segments[i] === indicatedSegment) {
                        winningSegmentNumber = i;
                        break;
                    }
                }
            } else {
                // Método alternativo: calcular el segmento basado en el ángulo de rotación
                const normalizedAngle = theWheel.rotationAngle % 360;
                const degreePerSegment = 360 / theWheel.segments.length;
                winningSegmentNumber = Math.floor(normalizedAngle / degreePerSegment) + 1;
                
                // Asegurarse de que está dentro del rango válido
                if (winningSegmentNumber >= theWheel.segments.length) {
                    winningSegmentNumber = 1;
                }
            }
            
            // Asegurarse de que el winningSegmentNumber es válido
            if (winningSegmentNumber >= userSegments.length) {
                winningSegmentNumber = 0;
            }
            
            // Obtener el nombre completo del ganador usando nuestro array de correspondencia
            const winnerName = userSegments[winningSegmentNumber];
            
            console.log("Segmento ganador:", winningSegmentNumber);
            console.log("Nombre del ganador:", winnerName);
            
            // Mostrar el resultado y resetear el estado
            resultName.textContent = winnerName;
            resultContainer.style.display = 'block';
            resultContainer.classList.add('bounce');
            
            // Resetear el estado del giro y el botón
            isSpinning = false;
            spinButton.disabled = false;
            spinButton.textContent = '¡MENEA!';
            
            // Quitar la animación de rebote después de 1 segundo
            setTimeout(() => {
                resultContainer.classList.remove('bounce');
            }, 1000);
        }
        
        // Función para girar la ruleta
        function startSpin() {
            if (isSpinning) return;
            
            isSpinning = true;
            resultContainer.style.display = 'none';
            spinButton.disabled = true;
            spinButton.textContent = 'Girando...';
            
            // Reset de la ruleta para una nueva vuelta
            theWheel.stopAnimation(false);
            theWheel.rotationAngle = 0;
            theWheel.draw();
            
            // Generar un ángulo de parada aleatorio
            const stopAngle = Math.floor(Math.random() * 360);
            
            // Configurar la animación para que se detenga en el ángulo calculado
            theWheel.animation.stopAngle = stopAngle;
            
            // Iniciar la animación
            theWheel.startAnimation();
            console.log("Girando la ruleta hasta el ángulo: " + stopAngle);
        }
        
        // Asignar evento al botón de girar
        spinButton.addEventListener('click', startSpin);
        
        // Ajustar tamaño del canvas para dispositivos móviles
        function resizeCanvas() {
            const canvas = document.getElementById('canvas');
            const container = document.getElementById('canvasContainer');
            
            if (window.innerWidth <= 576) {
                canvas.width = 320;
                canvas.height = 320;
                container.style.width = '320px';
                container.style.height = '320px';
                
                if (theWheel) {
                    theWheel.centerX = 160;
                    theWheel.centerY = 160;
                    theWheel.outerRadius = 150;
                    theWheel.draw();
                }
            } else {
                canvas.width = 434;
                canvas.height = 434;
                container.style.width = '434px';
                container.style.height = '434px';
                
                if (theWheel) {
                    theWheel.centerX = 217;
                    theWheel.centerY = 217;
                    theWheel.outerRadius = 207;
                    theWheel.draw();
                }
            }
        }
        
        // Ajustar tamaño al cargar y al cambiar el tamaño de la ventana
        window.addEventListener('load', resizeCanvas);
        window.addEventListener('resize', resizeCanvas);
    });
</script>
{% endblock %}